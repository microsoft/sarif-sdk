<Project ToolsVersion="12.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <MSBuildAllProjects>$(MSBuildAllProjects);$(MSBuildThisFileFullPath)</MSBuildAllProjects>
  </PropertyGroup>

  <PropertyGroup>
    <NuGetPath>$(MSBuildProjectDirectory)\..\..\.nuget</NuGetPath>
    <NuGetConfigPath>$(MSBuildProjectDirectory)\..\NuGet.Config</NuGetConfigPath>
    <JsonSchemaToDotNetPath>$(MSBuildProjectDirectory)\..\packages\Microsoft.Json.Schema.ToDotNet.1.1.0\tools\net461\Microsoft.Json.Schema.ToDotNet.Cli.exe</JsonSchemaToDotNetPath>
    <_ObjectModelOutputDirectory>$(FlavorIndependentIntermediateOutputPath)Autogenerated</_ObjectModelOutputDirectory>
  </PropertyGroup>
  
  <!-- This target runs only when we actually need to build the object model files, which should be
       only when the JSON schema changes. -->
  <Target Name="BuildObjectModel" Inputs="@(JsonSchemaFile)" Outputs="$(_ObjectModelOutputDirectory)\*.cs">
    <RemoveDir Directories="$(_ObjectModelOutputDirectory)" />
    <MakeDir Directories="$(_ObjectModelOutputDirectory)" />
    <ItemGroup>
      <FileWrites Include="$(_ObjectModelOutputDirectory)" />
    </ItemGroup>
    
    <Exec Command="&quot;$(NuGetPath)\NuGet.exe&quot; restore &quot;$(MSBuildThisFileDirectory)packages.config&quot; -PackagesDirectory &quot;$(MSBuildThisFileDirectory)\..\..\packages&quot; -ConfigFile &quot;$(NuGetConfigPath)&quot; -Verbosity quiet" />
    <Message Importance="high" Text="Generating SARIF object model..." />
    <Exec Command="&quot;$(JsonSchemaToDotNetPath)&quot; --schema-name Sarif --schema-file-path &quot;%(JsonSchemaFile.FullPath)&quot; --output-directory &quot;$(_ObjectModelOutputDirectory)&quot; --force-overwrite --namespace-name %(JsonSchemaFile.Namespace) --root-class-name %(JsonSchemaFile.RootClassName) --copyright-file-path &quot;%(JsonSchemaFile.CopyrightFilePath)&quot; --hints-file-path &quot;%(JsonSchemaFile.HintsFilePath)&quot; --generate-cloning-code --protected-init-methods --virtual-members" />
    <Message Text="Generated classes from @(JsonSchemaFile) -> $(_ObjectModelOutputDirectory)"/>
  </Target>
  <!--
  This target runs every build. It regenerates the SARIF object model classes
  from the JSON schema.
  -->
  <Target Name="BuildAndInjectObjectModel">
    <!-- Build the object model if necessary. -->
    <CallTarget Targets="BuildObjectModel" />
    
    <!-- Safety valve: It has happened a couple of times that the SARIF object
         model has required constructs that Microsoft.JSchema.ToDotNet could not
         yet generate. Historically these changes have affected two files: one
         of the SARIF object model classes, and the SarifRewritingVisitor class. 		
         In those situations, we modified those files by hand and checked the
         modified copies in to the NotYetAutoGenerated directory. We then, at
         our leisure, enhanced Microsoft.JSchema.ToDotNet to emit the required
         constructs, updated sarif-sdk to use the new version of Microsoft.JSchema.ToDotNet,
         and deleted the NotYetAutoGenerated files.
         
         So we keep this build step around so that if in future we run into
         this issue again, we can easily enable the sarif-sdk to support the
         required object model without waiting for Microsoft.JSchema.ToDotNet
         to catch up.  
      -->
      <ItemGroup>		
        <_NotYetAutoGeneratedFiles Include="NotYetAutoGenerated\*.cs" />
      </ItemGroup>

    <Copy SourceFiles="@(_NotYetAutoGeneratedFiles)"
            DestinationFolder="$(_ObjectModelOutputDirectory)" />
  </Target>
</Project>