<Project ToolsVersion="12.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <MSBuildAllProjects>$(MSBuildAllProjects);$(MSBuildThisFileFullPath)</MSBuildAllProjects>
  </PropertyGroup>

  <PropertyGroup>
    <!-- Inject object model building. Must be after Microsoft.CSharp.targets is imported. -->
    <CompileDependsOn>BuildAndInjectObjectModel;$(CompileDependsOn)</CompileDependsOn>
  </PropertyGroup>

  <PropertyGroup>
    <JsonSchemaToDotNetPath>..\packages\Microsoft.Json.Schema.ToDotNet.0.22.0\tools\JsonSchemaToDotNet.exe</JsonSchemaToDotNetPath>
    <_ObjectModelOutputDirectory>$(FlavorIndependentIntermediateOutputPath)Autogenerated</_ObjectModelOutputDirectory>
  </PropertyGroup>
  
  <!-- This target runs only when we actually need to build the object model files, which should be
       only when the JSON schema changes. -->
  <Target Name="BuildObjectModel" Inputs="@(JsonSchemaFile)" Outputs="$(_ObjectModelOutputDirectory)\*.cs">
    <RemoveDir Directories="$(_ObjectModelOutputDirectory)" />
    <MakeDir Directories="$(_ObjectModelOutputDirectory)" />
    <ItemGroup>
      <FileWrites Include="$(_ObjectModelOutputDirectory)" />
    </ItemGroup>

    <Exec Command="&quot;$(JsonSchemaToDotNetPath)&quot; --schema-name Sarif --schema-file-path &quot;%(JsonSchemaFile.FullPath)&quot; --output-directory &quot;$(_ObjectModelOutputDirectory)&quot; --force-overwrite --namespace-name %(JsonSchemaFile.Namespace) --root-class-name %(JsonSchemaFile.RootClassName) --copyright-file-path &quot;%(JsonSchemaFile.CopyrightFilePath)&quot; --hints-file-path &quot;%(JsonSchemaFile.HintsFilePath)&quot; --generate-cloning-code" />
    <Message Text="Generated classes from @(JsonSchemaFile) -> $(_ObjectModelOutputDirectory)"/>
  </Target>
  <!--
  This target runs every build. It runs the grammar generator (if necessary) and injects
  the outputs thereof into the C# build.
  -->
  <Target Name="BuildAndInjectObjectModel">
    <!-- Build the object model if necessary. -->
    <CallTarget Targets="BuildObjectModel" />
    
    <!-- Safety valve: It has happened a couple of times that the SARIF object
         model has required constructs that Microsoft.JSchema.ToDotNet could not
         yet generate. Historically these changes have affected two files: one
         of the SARIF object model classes, and the SarifRewritingVisitor class. 		
         In those situations, we modified those files by hand and checked the
         modified copies in to the NotYetAutoGenerated directory. We then, at
         our leisure, enhanced Microsoft.JSchema.ToDotNet to emit the required
         constructs, updated sarif-sdk to use the new version of Microsoft.JSchema.ToDotNet,
         and deleted the NotYetAutoGenerated files.
         
         So we keep this build step around so that if in future we run into
         this issue again, we can easily enable the sarif-sdk to support the
         required object model without waiting for Microsoft.JSchema.ToDotNet
         to catch up.  
      -->		
      <ItemGroup>		
        <_NotYetGeneratedFiles Include="NotYetAutoGenerated\*.cs" />		
      </ItemGroup>

    <Copy SourceFiles="@(_NotYetGeneratedFiles)"		
            DestinationFolder="$(_ObjectModelOutputDirectory)" />

    <ItemGroup>
      <!-- FileWrites are the set of files that get deleted on clean. -->
      <FileWrites Include="$(_ObjectModelOutputDirectory)\*.cs" />
      <!-- Compile are the set of files that go into the C# build. -->
      <Compile Include="$(_ObjectModelOutputDirectory)\*.cs" />
    </ItemGroup>
  </Target>
</Project>